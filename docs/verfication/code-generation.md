# Code generation

To support easier implementation of new attestation types and management of the existing ones, we provide special code generation support that enables boilerplate code generation given the type definitions.
The type definition files are placed the folder [src/verification/attestation-types/](../../src/verification/attestation-types/). Each type definition file has a special name of the form `t-<5-digit-id>-<dashed-name>.ts`. Once a file with such a name is provided, it is used by the code generation system to generate different pieces of code in the following folders:

- [lib/verification/verifiers](../../lib/verification/verifiers/)
- [lib/verification/generated](../../lib/verification/generated/)
- [contracts/generated](../../contracts/generated/)
- [test/generated](../../test/generated/)

## The folder `verification/verifiers`

This folder contains the file `verifier_routing.ts` in which there is a function

```Typescript
verifyAttestation(client: MccClient, attestation: Attestation, indexer: IndexedQueryManager, recheck = false)
```

This is the (only) top-level function that attestation client uses to verify all attestations. Given an object containing the attestation request, the function first determines the attestation type and the related data source. Then it routes the call to the specific verifier function. Specific verifier functions are generated in sub-folders of the `verifiers` folder named according to the data sources (e.g. `BTC`, `XRP`, etc.). In each such subfolder there are boilerplate implementations for each attestation type handling the specific data source. The files have special names of the form `v-<5-digit-id>-<dashed-name>.<source-name-lowercase>.ts`.

These files are autogenerated and are designed in such a way that a specific code can be injected into special parts of the file. The code generation system respects injected code when regenerating the surrounding boilerplate code. Example of such a file is [here](../../src/verification/verifiers/BTC/v-00001-payment.btc.ts). The developer can inject the code in two places:

- in the `import` section at the top of the file, immediately after the autogenerated `import` clause.
- in the part of the code enclosed between two comments starting with `//-$$$<start>` and `//-$$$<end>`. This is the part where custom verification code is written.

## The folder `verification/generated`

This folder contains several autogenerated files:

- [attestation-types-enum.ts](../../lib/verification/generated/attestation-types-enum.ts)- enum definition for attestation types.
- [attestation-request-types.ts](../../lib/verification/generated/attestation-request-types.ts) - types for attestation requests.
- [attestation-hash-types.ts](../../lib/verification/generated/attestation-hash-types.ts) - types for attestation responses.
- [attestation-request-encode.ts](../../lib/verification/generated/attestation-request-encode.ts) - functions for encoding the attestation request objects to byte strings.
- [attestation-request-parse.ts](../../lib/verification/generated/attestation-request-parse.ts) - functions for parsing attestation requests from byte strings to objects.
- [attestation-request-equals.ts](../../lib/verification/generated/attestation-request-equals.ts) - comparison functions for attestation request objects.
- [attestation-hash-utils.ts](../../lib/verification/generated/attestation-hash-utiles.ts) - hashing functions for attestation responses.
- [attestation-random-utils.ts](../../lib/verification/generated/attestation-hash-random.ts) - test functions for generating random attestation responses.

This folder can be considered as a library for typing and manipulating attestation requests and responses.

## The folder `contracts/generated`

In this folder there are several test interfaces and smart contracts which contain autogenerated code, that is used for verification of attestations. These include:

- Interfaces (`interfaces` subfolder)
  - [IAttestationClient.sol](../../contracts/generated/interface/IAttestationClient.sol) - interface for a generic verification contract, defines all relevant structs for attestation proofs.
  - [IStateConnector.sol](../../contracts/generated/interface/IStateConnector.sol) - generic interface for a State Connector contract, for the minimal necessary parts that a verification contract needs.
- Contracts (`contracts` subfolder)
  - [SCProofVerifierBase.sol](../../contracts/generated/contracts/SCProofVerifierBase.sol) - an abstract implementation of a contract that does verifications for all the supported attestation types. This contract should be inherited and the virtual method `merkleRootForRound(uint256 _stateConnectorRound)` should be implemented in order to get access to the confirmed Merkle root for a given voting round (`_stateConnectorRound`). The code from this contract together with the code from `ISCProofVerifier.sol` can be used for a framework for any contract that accepts and verifies attestations.
  - [SCProofVerifierMock.sol](../../contracts/generated/contracts/SCProofVerifierMock.sol) - a concrete implementation of the abstract contract `SCProofVerifierBase.sol`, where Merkle root is set manually.
  - [SCProofVerifier.sol](../../contracts/generated/contracts/SCProofVerifier.sol) - a concrete implementation of the abstract contract `SCProofVerifierBase.sol`, where Merkle root is obtained from a contract that supports the interface `IStateConnector.sol` (e.g. the real `StateConnector.sol` contract).
  - [StateConnectorMock.sol](../../contracts/generated/contracts/StateConnectorMock.sol) - a mock contract implementation that supports the interface `IStateConnector.sol` and allows manually setting Merkle roots for specific voting rounds.

## The folder `test/generated`

Contains autogenerated test files:

- [SCProofVerifierMock.test-contract.ts](../../test/generated/SCProofVerifierMock.test-contract.ts) - tests with mock and test smart contracts related to attestation responses, Merkle proofs and State Connector contract.
- [AttestationRequestParser.test-contract.ts](../../test/generated/AttestationRequestParser.test-contract.ts) - tests for encoding and parsing attestation requests

## Re-generating the code

Code can be re-generated by running

```bash
yarn codegen
```

Next: [Proof API](./proof-api.md)

[Back to home](../README.md)
